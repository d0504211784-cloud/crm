<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>CRM ××©×›× ×ª××•×ª - ×¡× ×›×¨×•×Ÿ ×¢× ×Ÿ</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #f0f4f8; margin: 0; padding: 20px; color: #333; }
        .hidden { display: none !important; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 25px; border-radius: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .stat-container { display: flex; gap: 15px; margin-bottom: 25px; }
        .stat-box { flex: 1; padding: 20px; border-radius: 15px; color: white; text-align: center; font-weight: bold; }
        .stat-total { background: linear-gradient(135deg, #4facfe, #00f2fe); }
        .stat-approved { background: linear-gradient(135deg, #43e97b, #38f9d7); }
        .customer-card { background: white; margin-bottom: 12px; padding: 15px 20px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-right: 6px solid #ccc; cursor: pointer; }
        .status-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-left: 12px; }
        .dot-approved { background: #28a745; } .dot-process { background: #ffc107; } .dot-none { background: #bbb; }
        input, select, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .save-btn { background: #28a745; color: white; padding: 15px; border: none; border-radius: 8px; width: 100%; cursor: pointer; font-weight: bold; }
        .add-btn { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .back-btn { background: #444; color: white; padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer; margin-bottom: 15px; }
        #idPreview { max-width: 100%; margin-top: 15px; border-radius: 10px; }
    </style>
    <!-- ×˜×¢×™× ×ª ×¡×¤×¨×™×•×ª Firebase -->
    <script src="https://www.gstatic.com"></script>
    <script src="https://www.gstatic.com"></script>
</head>
<body>

<div id="homePage" class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1>× ×™×”×•×œ ×œ×§×•×—×•×ª - ×¢× ×Ÿ</h1>
        <button class="add-btn" onclick="addNewCustomer()">+ ×œ×§×•×— ×—×“×©</button>
    </div>
    <div class="stat-container">
        <div class="stat-box stat-total"><div>×¡×”"×› ×œ×§×•×—×•×ª</div><div id="stat-total">0</div></div>
        <div class="stat-box stat-approved"><div>×ª×™×§×™× ×××•×©×¨×™×</div><div id="stat-approved">0</div></div>
    </div>
    <input type="text" id="searchInput" onkeyup="filterNames()" placeholder="×—×™×¤×•×© ×œ×§×•×— ×œ×¤×™ ×©×...">
    <div id="customerList"></div>
</div>

<div id="customerMenuPage" class="container hidden">
    <button class="back-btn" onclick="showPage('homePage')">â†’ ×—×–×¨×”</button>
    <h2 id="selectedNameTitle" style="text-align: center; color: #007bff;"></h2>
    <div style="display:flex; gap:10px;">
        <button onclick="showPage('idPage')" style="flex:1; padding:20px; background:#007bff; color:white; border-radius:10px; border:none; cursor:pointer;">××¡××›×™×</button>
        <button onclick="showPage('statusPage')" style="flex:1; padding:20px; background:#28a745; color:white; border-radius:10px; border:none; cursor:pointer;">×‘× ×§×™×</button>
        <button onclick="showPage('extraPage')" style="flex:1; padding:20px; background:#6f42c1; color:white; border-radius:10px; border:none; cursor:pointer;">×©×•× ×•×ª</button>
    </div>
</div>

<div id="idPage" class="container hidden">
    <button class="back-btn" onclick="showPage('customerMenuPage')">â†’ ×—×–×¨×”</button>
    <input type="tel" id="custPhone" placeholder="×˜×œ×¤×•×Ÿ">
    <input type="file" onchange="previewFile(this)">
    <img id="idPreview" class="hidden">
    <button class="save-btn" onclick="saveAllData()">×©××•×¨ ×”×›×œ ×œ×¢× ×Ÿ</button>
</div>

<div id="statusPage" class="container hidden">
    <button class="back-btn" onclick="showPage('customerMenuPage')">â†’ ×—×–×¨×”</button>
    <div id="bankList"></div>
    <button class="save-btn" onclick="saveAllData()">×©××•×¨ ×‘× ×§×™× ×œ×¢× ×Ÿ</button>
</div>

<div id="extraPage" class="container hidden">
    <button class="back-btn" onclick="showPage('customerMenuPage')">â†’ ×—×–×¨×”</button>
    <textarea id="freeText" rows="4" placeholder="×”×¢×¨×•×ª..."></textarea>
    <button class="save-btn" onclick="saveAllData()">×©××•×¨ ×œ×¢× ×Ÿ</button>
</div>

<script>
    var db;
    var allData = {};
    var currentCustomer = "";

    const firebaseConfig = {
        apiKey: "AIzaSyDA7AKVgoqUQ04QBlO6XM0ZwkaaEDYdU0Y",
        authDomain: "crm-start.firebaseapp.com",
        databaseURL: "https://crm-start-default-rtdb.firebaseio.com",
        projectId: "crm-start"
    };

    // ××ª×—×•×œ Firebase ×¨×§ ×œ××—×¨ ×©×”×“×£ × ×˜×¢×Ÿ ×‘××œ×•××•
    window.onload = function() {
        if (typeof firebase !== 'undefined') {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            
            // ×”××–× ×” ×œ×¢× ×Ÿ
            db.ref('customers').on('value', (snapshot) => {
                allData = snapshot.val() || {};
                renderCustomerList();
            });
            console.log("Firebase Connected");
        } else {
            alert("×©×’×™××”: ×¡×¤×¨×™×•×ª ×’×•×’×œ ×œ× × ×˜×¢× ×•. ×‘×“×•×§ ×—×™×‘×•×¨ ××™× ×˜×¨× ×˜.");
        }
    };

    function renderCustomerList() {
        const listDiv = document.getElementById('customerList');
        listDiv.innerHTML = '';
        const names = Object.keys(allData).sort();
        let approved = 0;

        names.forEach(name => {
            const data = allData[name] || {};
            const bStatuses = Object.values(data.banks || {});
            let dot = bStatuses.includes("××•×©×¨") ? "dot-approved" : (bStatuses.includes("×‘×ª×”×œ×™×š") ? "dot-process" : "dot-none");
            if (dot === "dot-approved") approved++;

            listDiv.innerHTML += `
                <div class="customer-card" onclick="openCustomer('${name}')">
                    <div style="display:flex; align-items:center;">
                        <span class="status-dot ${dot}"></span>
                        <strong>${name}</strong>
                    </div>
                    <button onclick="event.stopPropagation(); deleteCustomer('${name}')" style="background:none; border:none; cursor:pointer;">ğŸ—‘ï¸</button>
                </div>`;
        });
        document.getElementById('stat-total').innerText = names.length;
        document.getElementById('stat-approved').innerText = approved;
    }

    function addNewCustomer() {
        let name = prompt("×©× ×œ×§×•×— ×—×“×©:");
        if (name && !allData[name]) {
            db.ref('customers/' + name).set({ name: name, created: Date.now() })
              .then(() => alert("×œ×§×•×— × ×•×¡×£ ×œ×¢× ×Ÿ!"))
              .catch(e => alert("×©×’×™××ª ×”×¨×©××•×ª: " + e.message));
        }
    }

    function openCustomer(name) {
        currentCustomer = name;
        document.getElementById('selectedNameTitle').innerText = name;
        showPage('customerMenuPage');
    }

    function deleteCustomer(name) {
        if (confirm(`×œ××—×•×§ ××ª ${name}?`)) db.ref('customers/' + name).remove();
    }

    function showPage(id) {
        document.querySelectorAll('.container').forEach(d => d.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        if (id === 'statusPage') loadBankList();
        if (['idPage', 'statusPage', 'extraPage'].includes(id)) loadCustomerData();
    }

    function loadBankList() {
        const div = document.getElementById('bankList');
        div.innerHTML = '';
        const data = allData[currentCustomer] || {};
        const banks = ["×‘× ×§ ×œ××•××™", "×‘× ×§ ×”×¤×•×¢×œ×™×", "××–×¨×—×™ ×˜×¤×—×•×ª", "×‘× ×§ ×“×™×¡×§×•× ×˜", "×”×‘× ×§ ×”×‘×™× ×œ××•××™", "×—×•×¥ ×‘× ×§××™"];
        banks.forEach(b => {
            let s = data.banks?.[b] || "×œ× ×”×ª×—×™×œ";
            div.innerHTML += `
                <div class="bank-row ${s === '××•×©×¨' ? 'approved-bank' : ''}">
                    <strong>${b}:</strong>
                    <select id="bank-${b}">
                        <option ${s==='×œ× ×”×ª×—×™×œ'?'selected':''}>×œ× ×”×ª×—×™×œ</option>
                        <option ${s==='×‘×ª×”×œ×™×š'?'selected':''}>×‘×ª×”×œ×™×š</option>
                        <option ${s==='××•×©×¨'?'selected':''}>××•×©×¨</option>
                    </select>
                </div>`;
        });
    }

    function previewFile(input) {
        const reader = new FileReader();
        reader.onload = e => {
            document.getElementById('idPreview').src = e.target.result;
            document.getElementById('idPreview').classList.remove('hidden');
        };
        reader.readAsDataURL(input.files[0]);
    }

    function loadCustomerData() {
        const data = allData[currentCustomer] || {};
        if(document.getElementById('custPhone')) document.getElementById('custPhone').value = data.phone || "";
        if(document.getElementById('freeText')) document.getElementById('freeText').value = data.freeText || "";
        if(data.fileData) {
            document.getElementById('idPreview').src = data.fileData;
            document.getElementById('idPreview').classList.remove('hidden');
        }
    }

    function saveAllData() {
        let data = allData[currentCustomer] || {};
        data.phone = document.getElementById('custPhone').value;
        data.freeText = document.getElementById('freeText').value;
        if(!document.getElementById('idPreview').classList.contains('hidden')) data.fileData = document.getElementById('idPreview').src;

        if (!document.getElementById('statusPage').classList.contains('hidden')) {
            data.banks = {};
            const bList = ["×‘× ×§ ×œ××•××™", "×‘× ×§ ×”×¤×•×¢×œ×™×", "××–×¨×—×™ ×˜×¤×—×•×ª", "×‘× ×§ ×“×™×¡×§×•× ×˜", "×”×‘× ×§ ×”×‘×™× ×œ××•××™", "×—×•×¥ ×‘× ×§××™"];
            bList.forEach(b => {
                data.banks[b] = document.getElementById('bank-' + b).value;
            });
        }
        db.ref('customers/' + currentCustomer).update(data).then(() => alert("× ×©××¨ ×‘×¢× ×Ÿ!"));
    }

    function filterNames() {
        let v = document.getElementById('searchInput').value.toLowerCase();
        document.querySelectorAll('.customer-card').forEach(c => c.style.display = c.innerText.toLowerCase().includes(v) ? "flex" : "none");
    }
</script>
</body>
</html>
